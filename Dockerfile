# https://github.com/alikarimi999
# https://hub.docker.com/u/alikarimi999

FROM alpine:3.13.6

RUN apk update && apk add \
      autoconf \
      gcc \
      gdb \
      libdrm-dev \
      libepoxy-dev \
      make \
      mesa-dev \
      strace \
      g++ \
      nginx

COPY . /usr/src

WORKDIR /usr/src/haproxy

RUN make clean; \
		make TARGET=linux-glibc-legacy; \
		make install; \
		mkdir -p /etc/haproxy; \
		mkdir -p /var/lib/haproxy; \
		mkdir -p /run/nginx; \
		touch /var/lib/haproxy/stats; \
		ln -s /usr/local/sbin/haproxy /usr/sbin/haproxy; \
		mv ./examples/haproxy.init /etc/init.d/haproxy; \
		mv ./examples/haproxy.cfg /etc/haproxy/haproxy.cfg; \
		mv ../default.conf /etc/nginx/http.d/default.conf; \
		mv ../html /usr/share/nginx/; \
		chmod 755 /etc/init.d/haproxy; \
		chmod +x ../my_wrapper_script.sh

CMD ["sh","../my_wrapper_script.sh"]	
